---
title: "Notebook for BlueGreen project part 2"
author:
- Eric Harvey^1^, Isabelle Gounand^2^, Emanuel Fronhofer^3^, Florian Altermatt^2^
- ^1^Universite de Montreal, ^2^University of Zurich, ^3^University of Montpellier
output:
  html_document:
    df_print: paged
    toc: yes
  html_notebook:
    highlight: tango
    theme: readable
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
---

```{r setup, include=FALSE }
##################
#Load data in R environment
##################
library(tidyverse)
library(vegan)
library(RColorBrewer)
library(gridExtra)
library(nlme)
library(scales)

##################
#Directory paths 
##################
to.data <- "./data/"
to.script <- "./scripts/"
to.output <- "./output/"
to.figs <- "./figs/"
to.R <- "./output/"

##################
#Load data in R environment
##################
data = readRDS(paste0(to.output,"cl.data.RDS"))
SP <- c("Rot","Spi","Ble","Pca","Col","Chi","Tet") #comm matrix

##################
#Set colour gradient for each species
##################
#colvec <- brewer.pal(7,"Set2")
colvec <- c("#ff7f00","#1f78b4","navy","purple3","violetred","orangered2","#e31a1c")


```

# Analytical pipeline

The main objective of this project is to identify spatial feedbacks between two landscapes connected by the pulse exchange of resource (see Methods section in the main article). More specifically we are interested in effects of the main treatment (resource pulse) that are dependant on the position in the spatial network. Thus although we are interested in the main effect of our resource pulse treatment, our focus is on the interaction term between patch size (indicates position in the dendritic network) and resource pulse treatment. 

The analytical pipeline to achieve this objective can be synthesize as follow: 

- Effects from green ecosystem to blue ecosystem
  - On community composition
  - On aggregate community metrics (species richness, total density)
  
- Effects from blue ecosystem to green ecosystem
  - On aggregate bacteria metrics (total bacteria density)

Visual explorations from the `Overview.Rmd` already strongly suggests no important effects on aggregate metrics, but significant effects on community composition. For the manuscript, we will thus start by exploring the effect of resource pulse from the green ecosystem to community composition in the blue ecosystem, and then how resource pulse from the blue ecosystem affects bacteria density in the green ecosystem. Those results constitute the core findings presented in the manuscript. At the end we will use statistical modelling to formally test effects on aggregate metrics in the blue ecosystem. 


# Effect from Green to Blue ecosystem

## Ordination

```{r ordination setup, include=FALSE}
##################
# Ordination (temporal trends in community structure)
##################

#Create interaction variable
data$Treat.Size <- interaction(data$Treatment,data$Size) 
data$Treat.Day <- interaction(data$Treatment,data$day)
data$Treat.Size.Day <- interaction(data$Treatment,data$Size,data$day)

#Place vars of interest into vectors for each component of ordination
SP <- c("Rot","Spi","Ble","Pca","Col","Chi","Tet") #comm matrix
ENV <- c("day.cont","centrality","Size","dist.outlet","Treatment","Treat.Size","Treat.Size.Day") #Constrains
CONT <- c("Replicate") #Effect to partial out

#Filter data as wanted (for bacteria need to use only rep A and B)
X <- data %>% 
  filter(day!=0 & Replicate %in% c("A","B","C","D")) %>% 
  mutate(Treatment = as.factor(Treatment),
         day = factor(day,levels=c("0","7","15","21","29")),
         day.cont = as.numeric(as.character(day)),
         Size = as.numeric(as.character(Size)),
         centrality = as.numeric(as.character(centrality)),
         dist.outlet = as.numeric(as.character(dist.outlet)))
         

#Create matrices for analyses 
C <- decostand(X[,SP],"hell")
E <- X[,ENV]
Z <- as.matrix(X[,CONT])
```

We will use an RDA analysis with those three main components:

* Community matrix (C - Hellinger transformed)
```{r, echo=F}
head(C)
```
* Environmental matrix (E)
```{r, echo=F}
head(E)
```

So we ran the model:
```{r run_ordination, echo=TRUE}
rda.mod <- rda(C ~ ., as.data.frame(E))
rda.mod
summary(rda.mod)$concont
```

The model show that our environmental matrix explains roughly 31% of the variance, which is not amazing but not so bad. The first axis explains 71% of that 31% and the second axis 16%. 

We then ran a permutation ANOVA on the terms: 
```{r ordi_ANOVA, echo=T}
anova(rda.mod,by="terms",permu=200)
```

Here we can see that three variables are really standing out:

* Change in time
* Position in the landscape (centrality)
* Treatment (connected vs. isolated)

So it turns out that both the position in the landscape and resource pulse influence community position. Note that the interaction terms are also significant here indicating that the influence of the resource pulse on community composition vary as a function of the position in the network. The importance of these interaction terms in the model, however, remains fairly low compared to the main effects. 

Let's explore this model visually

```{r ordination figs, echo=FALSE, dpi=400, dev=c('png', 'pdf'), warning=FALSE}
#colvec.R <- brewer.pal(3,"Dark2")
colvec.R = c("darkgreen","chartreuse3")

##Plot
ordiplot(rda.mod,display="site",type="n",xlim=c(-1.5,1.6),cex.axis=1.4,cex.lab=1.4)
points(rda.mod, display="cn", col="gray20",cex=0.0001,lwd=2)
text(rda.mod, display="sp", col=colvec,cex=1.5,lwd=2)
text(x=-0.95,y=-0.68,"T",col="gray20",cex=1.5)
text(x=-0.38,y=0.68,"C",col="gray20",cex=1.5)
text(x=-0.33,y=0.72,"V",col="gray20",cex=1.5)
text(x=0.35,y=-0.65,"D",col="gray20",cex=1.5) 
```

First looking at the predictors (arrows) one can see that higher patch volume and high centrality values co-varies, which make sense since larger patches are generally more connected. In direct opposition (180 degrees on the figure) higher distance to outlet values are found which also make sense since smaller patches are mainly found upstream and thus further from the outlet. Orthogonal to this gradient (90 degree) is the effect of time. The species scores are well distributed on the plot as a function of the different constraints. Each point on the figure is a microcosm with the two colors identifying them as being part of a connected or an isolated blue ecosystem. From the model we know that the effect of the treatment is significant and relatively important. Here we can see that there is indeed some level of difference between sites in connected and isolated ecosystems.  

Now in terms of interpretation, we can see that PCA and COL are more strongly associated with sites in connected ecosystem while Spi, Tet and Chi are associated with sites in isolated ecosystems. There are some interactions with other preditors though. For instance the figure suggest that PCA also became more abundant later in the experiment, while SPI was more abundant earlier suggesting some temporal community dynamics. Most interestingly, as mentionned, TET and CHI are associated with sites in isolated ecosystem, BUT also sites that tend to be more upstream in these ecosystems (smaller patch size more distant from the outlet). On the opposite ROT seems to be more associated to downstream sites (high centrality, high patch volume) independant of treatment or temporal aspect.

## Log-ratio 

Another useful way of representing those results is by using the log response ratio here defined has: 

**LRR = log( mean(connected) / mean(isolated) )**

with confidence interval: 

**95CI = LRR +- 1.96 x SE(LRR)**

In complementarity with the RDA model, let's look at the log response ratio of the different protist species to the main treatment. 

```{r LRR per species, echo=FALSE}

#-- Get the LRR data for protists for Day 7 to 29 all patch size pooled
#----------------------------------------------------------------------
{
#Create output file
LRR_Res_protist <- data.frame(species=character(0),LRR=numeric(0),CI_upper=numeric(0),CI_lower=numeric(0))

#Loop for each species
for(i in 1:length(SP)) { 
  
  # Extract info for SP[i] and summarise data
  D_Res_protist <- data %>% 
    filter(day !=0) %>% 
    select(SP[i],day, Treatment, Replicate, Size, centrality, degree, dist.outlet) %>% 
    mutate(Treatment = as.factor(Treatment),
           Replicate = as.factor(Replicate),
           Size = as.factor(Size))  %>% 
    Rmisc::summarySE(.,measurevar = SP[i], groupvars = c("Treatment")) #get the mean by treatment level for each species
  
  LRR <- log(D_Res_protist[1,3]) - log(D_Res_protist[2,3]) 
  SE_LRR <- sqrt( (D_Res_protist$se[1]^2/D_Res_protist[1,3]^2) + (D_Res_protist$se[2]^2/D_Res_protist[2,3]^2) ) #From Hedge et al., 1999
  CI_upper <- LRR + 1.96*SE_LRR
  CI_lower <- LRR - 1.96*SE_LRR
  #CI_both <- LRR + c(-1, 1) * qnorm(1 - (1 - 0.95)/2) * SE_LRR #from ARPobservation:::logRespRatio
  species <- SP[i]
  
  bind.out_Res_protist <- data.frame(species,LRR,CI_upper,CI_lower)
  #colnames(bind.out) <- c("time","size","LRR","species","CI_upper","CI_lower")
  
  LRR_Res_protist <- rbind.data.frame(LRR_Res_protist,bind.out_Res_protist)
  
}

}

#-- Get the LRR data for BACTERIA IN GREEN for Day 7 to 29 all patches pooled
#-------------------------------------------------------------------
{
  ####Generate data for LRR calculation
  D_Res_green <- data %>% 
    filter(day !=0 & Replicate %in% c("A","B")) %>% 
    Rmisc::summarySE(.,measurevar = "bact.green", groupvars = c("Treatment"))
  
  #Calculate LRR
  species <- "bacteriaG"
  LRR <- log(D_Res_green[1,3]) - log(D_Res_green[2,3]) 
  SE_LRR <- sqrt( (D_Res_green$se[1]^2/D_Res_green[1,3]^2) + (D_Res_green$se[2]^2/D_Res_green[2,3]^2) ) #From Hedge et al., 1999
  CI_upper <- LRR + 1.96*SE_LRR
  CI_lower <- LRR - 1.96*SE_LRR
}
bind.out_Res_green <- data.frame(species,LRR,CI_upper,CI_lower)

#-- Get the LRR data for BACTERIA IN BLUE for Day 7 to 29 all patches pooled
#-------------------------------------------------------------------
{
  ####Generate data for LRR calculation
  D_Res_blue <- data %>% 
    filter(day !=0 & Replicate %in% c("A","B")) %>% 
    Rmisc::summarySE(.,measurevar = "bact.blue", groupvars = c("Treatment"))
  
  #Calculate LRR
  species <- "bacteriaB"
  LRR <- log(D_Res_blue[1,3]) - log(D_Res_blue[2,3]) 
  SE_LRR <- sqrt( (D_Res_blue$se[1]^2/D_Res_blue[1,3]^2) + (D_Res_blue$se[2]^2/D_Res_blue[2,3]^2) ) #From Hedge et al., 1999
  CI_upper <- LRR + 1.96*SE_LRR
  CI_lower <- LRR - 1.96*SE_LRR
}
bind.out_Res_blue <- data.frame(species,LRR,CI_upper,CI_lower)

#-- Put all data together
#-------------------------------------------------------------------
LRR_sp <- rbind(LRR_Res_protist,bind.out_Res_blue,bind.out_Res_green)
LRR_sp
```

```{r fig LRR per species, echo=FALSE, dev=c('png', 'pdf'), dpi=400}
layout(1)
plot(c(1:8,10),LRR_sp$LRR,type="n",xlim=c(0.5,10.5),xlab = "Species",ylab = "Effect size (log ratio of mean densities)",ylim=c(-0.8,0.32), yaxt="n",xaxt="n",cex.lab=1.4,main ="Day 7 to 29")
axis(2,at = c(-0.8,-0.6,-0.4,-0.2,0,0.2,0.4),labels = c(-0.8,-0.6,-0.4,-0.2,0,0.2,0.4),cex.axis=1.2,las=2)
axis(1,at = c(1:8,10),labels = levels(LRR_sp$species),cex.axis=1.2)
abline(h=0,lty=3); abline(v=9,lwd=1)
segments(x0=c(1:8,10),x1=c(1:8,10),y0=LRR_sp$CI_upper,y1=LRR_sp$CI_lower,col=c(colvec,"grey60","darkgreen"),lwd=3)
points(c(1:8,10),LRR_sp$LRR,col=c(colvec,"grey60","darkgreen"),pch=20,cex=2.5)

```

This figure conveys very similar information to the RDA figure: PCA and COL tend to be more abundant in microcosms from connected ecosystems while CHI, TET and BLE tend to be more abundant in microcosms from isolated ecosystems. GREAT! 

Now let's see if we can still detect the interaction with position in the network using patch size (which according to the RDA is the same as using distance to outlet or centrality): 

```{r LRR by patch size, echo=FALSE}
###############################################################
#-- BY PATCH SIZE
#--------------------------------------------------------------

#-- Get the LRR data for protist for Day 7 to 29 by patch size
#---------------------------------------------------------------

{
  #Create output file
LRR_Res_Vol_protist <- data.frame(size=numeric(0),species=character(0),LRR=numeric(0),CI_upper=numeric(0),CI_lower=numeric(0))

#Loop for each species

for(i in 1:length(SP)) { 
  
  # Extract info for SP[i] and summarise data
  D_Res_Vol_protist <- data %>% 
    filter(day !=0) %>% 
    select(SP[i],day, Treatment, Replicate, Size, centrality, degree, dist.outlet) %>% 
    mutate(Treatment = as.factor(Treatment),
           Replicate = as.factor(Replicate),
           Size = as.factor(Size))  %>% 
    Rmisc::summarySE(.,measurevar = SP[i], groupvars = c("Treatment","Size"))
  
  LRR.7 <- log(D_Res_Vol_protist[1,4]) - log(D_Res_Vol_protist[5,4]) 
  LRR.13 <- log(D_Res_Vol_protist[2,4]) - log(D_Res_Vol_protist[6,4]) 
  LRR.22 <- log(D_Res_Vol_protist[3,4]) - log(D_Res_Vol_protist[7,4]) 
  LRR.45 <- log(D_Res_Vol_protist[4,4]) - log(D_Res_Vol_protist[8,4]) 
  LRR <- rbind(LRR.7,LRR.13,LRR.22,LRR.45)
  
  SE_LRR.7 <- sqrt( (D_Res_Vol_protist$se[1]^2/D_Res_Vol_protist[1,4]^2) + (D_Res_Vol_protist$se[5]^2/D_Res_Vol_protist[5,4]^2) )
  SE_LRR.13 <- sqrt( (D_Res_Vol_protist$se[2]^2/D_Res_Vol_protist[2,4]^2) + (D_Res_Vol_protist$se[6]^2/D_Res_Vol_protist[6,4]^2) )
  SE_LRR.22 <- sqrt( (D_Res_Vol_protist$se[3]^2/D_Res_Vol_protist[3,4]^2) + (D_Res_Vol_protist$se[7]^2/D_Res_Vol_protist[7,4]^2) )
  SE_LRR.45 <- sqrt( (D_Res_Vol_protist$se[4]^2/D_Res_Vol_protist[4,4]^2) + (D_Res_Vol_protist$se[8]^2/D_Res_Vol_protist[8,4]^2) )
  SE_LRR <- rbind(SE_LRR.7,SE_LRR.13,SE_LRR.22,SE_LRR.45)
  
  CI_upper.7 <- LRR.7 + 1.96*SE_LRR.7
  CI_upper.13 <- LRR.13 + 1.96*SE_LRR.13
  CI_upper.22 <- LRR.22 + 1.96*SE_LRR.22
  CI_upper.45 <- LRR.45 + 1.96*SE_LRR.45
  CI_upper <- rbind(CI_upper.7,CI_upper.13,CI_upper.22,CI_upper.45)
  
  CI_lower.7 <- LRR.7 - 1.96*SE_LRR.7
  CI_lower.13 <- LRR.13 - 1.96*SE_LRR.13
  CI_lower.22 <- LRR.22 - 1.96*SE_LRR.22
  CI_lower.45 <- LRR.45 - 1.96*SE_LRR.45
  CI_lower <- rbind(CI_lower.7,CI_lower.13,CI_lower.22,CI_lower.45)
  
  species <- rep(SP[i],4)
  size <- unique(D_Res_Vol_protist$Size)
  
  bind.out_Res_Vol_protist <- data.frame(size,species,LRR,CI_upper,CI_lower)
  #colnames(bind.out) <- c("time","size","LRR","species","CI_upper","CI_lower")
  
  LRR_Res_Vol_protist <- rbind.data.frame(LRR_Res_Vol_protist,bind.out_Res_Vol_protist)
  
}
}

#-- Get the LRR data for BACTERIA GREEN for Day 7 to 29 by patch size
#---------------------------------------------------------------

{
D_Res_Vol_green <- data %>% 
  filter(day !=0 & Replicate %in% c("A","B")) %>% 
  Rmisc::summarySE(.,measurevar = "bact.green", groupvars = c("Treatment","Size"))


#Calculate LRR
species <- "bacteria"
LRR.7 <- log(D_Res_Vol_green[1,4]) - log(D_Res_Vol_green[5,4]) 
LRR.13 <- log(D_Res_Vol_green[2,4]) - log(D_Res_Vol_green[6,4])
LRR.22 <- log(D_Res_Vol_green[3,4]) - log(D_Res_Vol_green[7,4])
LRR.45 <- log(D_Res_Vol_green[4,4]) - log(D_Res_Vol_green[8,4])
LRR <- rbind(LRR.7,LRR.13,LRR.22,LRR.45)

SE_LRR.7 <- sqrt( (D_Res_Vol_green$se[1]^2/D_Res_Vol_green[1,4]^2) + (D_Res_Vol_green$se[5]^2/D_Res_Vol_green[5,4]^2) ) #From Hedge et al., 1999
SE_LRR.13 <- sqrt( (D_Res_Vol_green$se[2]^2/D_Res_Vol_green[2,4]^2) + (D_Res_Vol_green$se[6]^2/D_Res_Vol_green[6,4]^2) )
SE_LRR.22 <- sqrt( (D_Res_Vol_green$se[3]^2/D_Res_Vol_green[3,4]^2) + (D_Res_Vol_green$se[7]^2/D_Res_Vol_green[7,4]^2) )
SE_LRR.45 <- sqrt( (D_Res_Vol_green$se[4]^2/D_Res_Vol_green[4,4]^2) + (D_Res_Vol_green$se[8]^2/D_Res_Vol_green[8,4]^2) )
SE_LRR <- rbind(SE_LRR.7,SE_LRR.13,SE_LRR.22,SE_LRR.45)

CI.7 <- 1.96*SE_LRR.7
CI.13 <- 1.96*SE_LRR.13
CI.22 <- 1.96*SE_LRR.22
CI.45 <- 1.96*SE_LRR.45
CI <- rbind(CI.7,CI.13,CI.22,CI.45)

size <- unique(D_Res_Vol_green$Size)
}
bind.out_Res_Vol_green <- data.frame(size,LRR,CI)


#-- Get the LRR data for BACTERIA BLUE for Day 7 to 29 by patch size
#-------------------------------------------------------------------

{
  D_Res_Vol_blue <- data %>% 
    filter(day !=0 & Replicate %in% c("A","B")) %>% 
    Rmisc::summarySE(.,measurevar = "bact.blue", groupvars = c("Treatment","Size"))
  
  
  #Calculate LRR
  species <- "bacteria"
  LRR.7 <- log(D_Res_Vol_blue[1,4]) - log(D_Res_Vol_blue[5,4]) 
  LRR.13 <- log(D_Res_Vol_blue[2,4]) - log(D_Res_Vol_blue[6,4])
  LRR.22 <- log(D_Res_Vol_blue[3,4]) - log(D_Res_Vol_blue[7,4])
  LRR.45 <- log(D_Res_Vol_blue[4,4]) - log(D_Res_Vol_blue[8,4])
  LRR <- rbind(LRR.7,LRR.13,LRR.22,LRR.45)
  
  SE_LRR.7 <- sqrt( (D_Res_Vol_blue$se[1]^2/D_Res_Vol_blue[1,4]^2) + (D_Res_Vol_blue$se[5]^2/D_Res_Vol_blue[5,4]^2) ) #From Hedge et al., 1999
  SE_LRR.13 <- sqrt( (D_Res_Vol_blue$se[2]^2/D_Res_Vol_blue[2,4]^2) + (D_Res_Vol_blue$se[6]^2/D_Res_Vol_blue[6,4]^2) )
  SE_LRR.22 <- sqrt( (D_Res_Vol_blue$se[3]^2/D_Res_Vol_blue[3,4]^2) + (D_Res_Vol_blue$se[7]^2/D_Res_Vol_blue[7,4]^2) )
  SE_LRR.45 <- sqrt( (D_Res_Vol_blue$se[4]^2/D_Res_Vol_blue[4,4]^2) + (D_Res_Vol_blue$se[8]^2/D_Res_Vol_blue[8,4]^2) )
  SE_LRR <- rbind(SE_LRR.7,SE_LRR.13,SE_LRR.22,SE_LRR.45)
  
  CI.7 <- 1.96*SE_LRR.7
  CI.13 <- 1.96*SE_LRR.13
  CI.22 <- 1.96*SE_LRR.22
  CI.45 <- 1.96*SE_LRR.45
  CI <- rbind(CI.7,CI.13,CI.22,CI.45)
  
  size <- unique(D_Res_Vol_blue$Size)
}
bind.out_Res_Vol_blue <- data.frame(size,LRR,CI)



#--- Pool protist and bacteria LRR data per patch size
LRR_size=rbind(LRR_Res_Vol_protist,
          data.frame("size" = bind.out_Res_Vol_blue$size,"species"=rep("BacteriaB",4),"LRR"=bind.out_Res_Vol_blue$LRR,"CI_upper"=bind.out_Res_Vol_blue$LRR+bind.out_Res_Vol_blue$CI,"CI_lower"=bind.out_Res_Vol_blue$LRR-bind.out_Res_Vol_blue$CI),
          data.frame("size" = bind.out_Res_Vol_green$size,"species"=rep("BacteriaG",4),"LRR"=bind.out_Res_Vol_green$LRR,"CI_upper"=bind.out_Res_Vol_green$LRR+bind.out_Res_Vol_green$CI,"CI_lower"=bind.out_Res_Vol_green$LRR-bind.out_Res_Vol_green$CI))
row.names(LRR_size) <- 1:nrow(LRR_size)
LRR_size
```


```{r Fig LRR by patch size, echo=FALSE, dev=c('png', 'pdf'), dpi=400}
##-- Plot the results with detailed on patch size
##-----------------------------------------------

#--- positions on the x-axis
pos7.5 = c(1,7,13,19,25,31,37,43,50)
labelPos = c(2,8,14,20,26,32,38,44,51)+0.5

#--- patch sizes and size of point to display patch size
sizes = levels(LRR_size$size)
cexVol= c(0.8,1.3,1.8,2.5)

plot(NA,type="n",xlim=c(0,54),col=c(colvec,"black"),xlab = "Species",ylab = "Effect size (log ratio of mean densities)",ylim=c(-1.4,0.8), yaxt="n",xaxt="n",cex.lab=1.4,main ="Day 7 to 29")
axis(2,at = c(-1.2,-0.8,-0.4,0,0.4,0.8),labels = c(-1.2,-0.8,-0.4,0,0.4,0.8),cex.axis=1.2,las=2)
axis(1,at = labelPos,labels = levels(LRR_size$species),cex.axis=1.2)
abline(h=0,lty=3); abline(v=48,lwd=1)

for(i in 1:length(levels(LRR_size$size))){
  subdat = subset(LRR_size,size==sizes[i])
  segments(x0=c(pos7.5+i-1),c(pos7.5+i-1),y0=subdat$CI_upper,y1=subdat$CI_lower,col=c(colvec,"grey60","darkgreen"),lwd=2)
  points(c(pos7.5+i-1),subdat$LRR,col=c(colvec,"grey60","darkgreen"),pch=20,cex=cexVol[i])
}

legend("bottomleft",lty=rep(1,4),pch=20,pt.cex=cexVol,lwd=2,legend = sizes,title="Patch sizes",bty = "n",cex=0.8)



```

Again, the same information is conveyed. We do see the interaction with PCA and COL being more abundant in the upstream (smaller volume) of the connected ecosystem, and CHI and TET being more abundant in the upstream (smaller volume) patches of the isolated ecosystem. For CHI this is also true for intermediate patch sizes.

## Preliminary conclusion
The results presented above suggest that: 

* Resource pulse from the green ecosystem does affect the structre of the community in the blue ecosystem by selecting for and againts some species
* This effect depend on the position in the blue spatial network and tend to be stronger in smaller, more isolated patches (based on patch volume, centrality and distance to the outlet)

# Effect from Blue to Green ecosystem

Here the main question of interest is whether we can see imprint of what was going on in the blue ecosystem. Using the log ratio approach seems to be one of the best way to visualize those effects: 

## Log-ratio

```{r LRR figure 3 green, echo=FALSE, dpi=400}
####Generate data for LRR calculation
D_Res_green <- data %>% 
  filter(day !=0 & Replicate %in% c("A","B")) %>% 
  Rmisc::summarySE(.,measurevar = "bact.green", groupvars = c("Treatment"))

#Calculate LRR
  species <- "bacteria"
  LRR <- log(D_Res_green[1,3]) - log(D_Res_green[2,3]) 
  SE_LRR <- sqrt( (D_Res_green$se[1]^2/D_Res_green[1,3]^2) + (D_Res_green$se[2]^2/D_Res_green[2,3]^2) ) #From Hedge et al., 1999
  CI_upper <- LRR + 1.96*SE_LRR
  CI_lower <- LRR - 1.96*SE_LRR
  
  bind.out_Res_green <- data.frame(species,LRR,CI_upper,CI_lower)
  
# Plot 
ggplot(bind.out_Res_green,mapping=aes(x=species,y=LRR)) + coord_cartesian(ylim = c(-0.1,0.5)) +
  ylab("Effect size (log ratio of means)") + xlab("Bacteria in green ecosystem") +
  geom_errorbar(aes(ymin=CI_lower, ymax=CI_upper), width=0) +
  geom_point() +
  geom_hline(yintercept=0,lty=2) +
  annotate("text", x=0.7, y=0.7,label="log(R+/R-) > 0",size=2.5,colour="darkgreen") + 
  annotate("text", x=0.7, y=-1.5,label="log(R+/R-) < 0",size=2.5,colour="darkred") + theme_classic()
  
```

So there is a tendancy for bacteria density in the green ecosystem to be higher when connected to the blue ecosystem versus isolated controls. Let's see if we can detect any interactions, even weak, with the position in the blue ecosystem:

```{r LRR figure 4 green, echo=FALSE, dpi=400}
D_Res_Vol_green <- data %>% 
  filter(day !=0 & Replicate %in% c("A","B")) %>% 
  Rmisc::summarySE(.,measurevar = "bact.green", groupvars = c("Treatment","Size"))


#Calculate LRR
species <- "bacteria"
LRR.7 <- log(D_Res_Vol_green[1,4]) - log(D_Res_Vol_green[5,4]) 
LRR.13 <- log(D_Res_Vol_green[2,4]) - log(D_Res_Vol_green[6,4])
LRR.22 <- log(D_Res_Vol_green[3,4]) - log(D_Res_Vol_green[7,4])
LRR.45 <- log(D_Res_Vol_green[4,4]) - log(D_Res_Vol_green[8,4])
LRR <- rbind(LRR.7,LRR.13,LRR.22,LRR.45)

SE_LRR.7 <- sqrt( (D_Res_Vol_green$se[1]^2/D_Res_Vol_green[1,4]^2) + (D_Res_Vol_green$se[5]^2/D_Res_Vol_green[5,4]^2) ) #From Hedge et al., 1999
SE_LRR.13 <- sqrt( (D_Res_Vol_green$se[2]^2/D_Res_Vol_green[2,4]^2) + (D_Res_Vol_green$se[6]^2/D_Res_Vol_green[6,4]^2) )
SE_LRR.22 <- sqrt( (D_Res_Vol_green$se[3]^2/D_Res_Vol_green[3,4]^2) + (D_Res_Vol_green$se[7]^2/D_Res_Vol_green[7,4]^2) )
SE_LRR.45 <- sqrt( (D_Res_Vol_green$se[4]^2/D_Res_Vol_green[4,4]^2) + (D_Res_Vol_green$se[8]^2/D_Res_Vol_green[8,4]^2) )
SE_LRR <- rbind(SE_LRR.7,SE_LRR.13,SE_LRR.22,SE_LRR.45)

CI.7 <- 1.96*SE_LRR.7
CI.13 <- 1.96*SE_LRR.13
CI.22 <- 1.96*SE_LRR.22
CI.45 <- 1.96*SE_LRR.45
CI <- rbind(CI.7,CI.13,CI.22,CI.45)

size <- unique(D_Res_Vol_green$Size)

bind.out_Res_Vol_green <- data.frame(size,LRR,CI)

ggplot(bind.out_Res_Vol_green,mapping=aes(x=as.factor(size),y=LRR)) + coord_cartesian(ylim = c(-0.01,0.7)) +
  ylab("Effect size (log ratio of means)") + xlab("Patch volume (mL)") +
  geom_errorbar(aes(ymin=LRR-CI_lower, ymax=LRR+CI_upper), colour="darkgreen", width=0) +
  geom_point(colour="darkgreen") +
  geom_hline(yintercept=0,lty=2) +
  annotate("text", x=0.7, y=0.7,label="log(R+/R-) > 0",size=2.5,colour="darkgreen") + 
  annotate("text", x=0.7, y=-0.01,label="log(R+/R-) < 0",size=2.5,colour="darkred") + theme_classic()
  
```

Interestingly, the positive effect of being connected to the blue ecosystem is even across the green ecosystem no matter where they are connected in the dendritic network. It suggests that disperal along the lattice network act as a strong homogenizing force. There is an unsignificant trend here, nonetheless interesting, where the Effect size seems to follow a hump shape relationship with patch size. It is interesting because it somehow follow connectance in the blue ecosystem (middle patch size are most connected compared to smallest and largest): 
```{r figure connectance dendritic network, echo=FALSE, dpi=400}
D_connectance <- data %>%
  filter(day !=0) %>% 
  mutate(Size = as.numeric(as.character(Size))) %>% 
  Rmisc::summarySE(.,measurevar = "degree", groupvars = c("Size"))

ggplot(D_connectance,mapping=aes(x=Size,y=degree)) +
  ylab("Connectance (degree)") + xlab("Patch volume (mL)") +
  geom_errorbar(aes(ymin=degree-se, ymax=degree+se), width=0) +
  geom_point() + theme_classic()
```

Let's explore those effects with a proper statistical model:
```{r nlme_green_bact, echo=TRUE, eval=TRUE}

#Extract data 

X.bact <- data %>% 
  filter(day!=0 & Replicate %in% c("A","B")) %>% 
  mutate(Treatment = as.factor(Treatment),
         day = factor(day,levels=c("7","15","21","29")),
         day.cont = log(as.numeric(as.character(day))),
         Size = as.numeric(as.character(Size)),
         centrality = as.numeric(as.character(centrality)),
         dist.outlet = as.numeric(as.character(dist.outlet)))

#Run model (no log transformation based on histogramm of residuals)
  #Also: here Time was not significant so it was removed from the fixed variables
Mod4 <- nlme:::lme(bact.green ~ Treatment*Size + degree + bact.blue + prot.ab + prot.rich, 
                   random = ~ as.factor(day)|Replicate, data=X.bact,
                   method="ML",control=lmeControl(optimMethod="BFGS",maxIter=100,opt="optim"))
summary(Mod4)$tTable

```

From the model, we obtain the same information as with our LRR. There is a significant reduction of bacteria density in isolated green ecosystem compared to the ones connected to a blue ecosystem. Changes associated with size or degree are not significants. 

# Conclusion

Main conclusions:

* The effect of resource pulse on the blue ecosystem depends on the position in the spatial network
* This network mediated effect also feed back on the green ecosystem 
* Upstream (smaller volume, higher distance to outlet and lower centrality) sites are key to this spatial feedback as they are the most responsive to resource pulse and probably most dependant on those resource pulse. 

# Addendum: aggregate community metrics

Visual exploration from the `Overview.Rmd` already strongly suggests no effects on aggregate metrics. We will here use mixed effects modeling to directly test effects on bacteria and protist densities, and protist species richness. We will then see if those results can inform or not our main results presented above.  

* Effect of resource pulse from Green ecosystem on Bacteria density in Blue ecosystem
```{r nlme_data, echo=FALSE, eval=TRUE}
# Filter data (bacteria were only measured for replicates A and B)

X.bact <- data %>% 
  filter(day!=0 & Replicate %in% c("A","B")) %>% 
  mutate(Treatment = as.factor(Treatment),
         day = factor(day,levels=c("7","15","21","29")),
         day.cont = log(as.numeric(as.character(day))),
         Size = as.numeric(as.character(Size)),
         centrality = as.numeric(as.character(centrality)),
         dist.outlet = as.numeric(as.character(dist.outlet)))

X.prot <- data %>% 
  filter(day!=0 & Replicate %in% c("A","B","C","D")) %>% 
  mutate(Treatment = as.factor(Treatment),
         day = factor(day,levels=c("7","15","21","29")),
         day.cont = log(as.numeric(as.character(day))),
         Size = as.numeric(as.character(Size)),
         centrality = as.numeric(as.character(centrality)),
         dist.outlet = as.numeric(as.character(dist.outlet)))
```

Let's print out the t Table
```{r nlme_blue_bact_results, echo=TRUE, eval=TRUE}
#Run model (no log transformation based on histogramm of residuals)
Mod1 <- nlme:::lme(bact.blue ~ Treatment*Size*day.cont + bact.green, 
                   random = ~ 1|Replicate, data=X.bact,
                   method="ML",control=lmeControl(optimMethod="BFGS",maxIter=100,opt="optim"))
summary(Mod1)$tTable
```

We can see that three effects come as statistically significant: 
- Size (only on day 29): decline of bacteria density with increasing patch size
- Day: average increases of bacteria density over experimental time

```{r nlme_blue_bact_figure, echo=FALSE, eval=TRUE}

# Generate data frame with each predictor to extract predictions
newdat <-  with(X.bact,
                 expand.grid(Treatment=unique(Treatment),
                             Size = c(min(Size),max(Size)),
                             bact.green=c(min(bact.green),max(bact.green)),
                             day.cont = c(min(day.cont),max(day.cont))))

X.1 <- X.bact %>% 
  filter(day==29)

ggplot(mapping=aes(x=as.factor(Size),y=log(bact.blue)),data=X.1) +
  geom_boxplot(col="blue",alpha=0.5) -> p1

ggplot(mapping=aes(x=day.cont,y=bact.blue),data=X.bact) +
  geom_point(col="blue",alpha=0.5) +
  geom_line(data=newdat,aes(y=predict(Mod1,newdata=newdat,level=0)),col="red") -> p2

grid.arrange(p1,p2,ncol=2)

```

* Effect of resource pulse from Green ecosystem on protist density in Blue ecosystem
```{r nlme_prot_dens, echo=TRUE, eval=TRUE}
#Run model (no log transformation based on histogramm of residuals)
Mod2 <- nlme:::lme(prot.ab ~ Treatment*Size*day.cont, 
                   random = ~ 1|Replicate, data=X.prot,
                   method="ML",control=lmeControl(optimMethod="BFGS",maxIter=100,opt="optim"))
summary(Mod2)$tTable
```

We can see that three effects come as statistically significant: 
- Size: Decline of protist abundance with increasing patch size
  - The effect change with time
- Day: Strong decline of protist density over experimental time

```{r nlme_prot_dens_figure, echo=FALSE, eval=TRUE}

# Plot results

ggplot(mapping=aes(x=as.factor(Size),y=prot.ab),data=X.prot) +
  geom_boxplot() + facet_wrap(~ day)   



ggplot(mapping=aes(x=day,y=prot.ab),data=X.prot) +
   geom_boxplot(col="blue",alpha=0.5) 


```

* Effect of resource pulse from Green ecosystem on protist richness in Blue ecosystem

```{r nlme_prot_rich, echo=TRUE, eval=TRUE}
#Run model (no log transformation based on histogramm of residuals)
Mod3 <- nlme:::lme(prot.rich ~ Treatment*Size*day.cont, 
                   random = ~ 1|Replicate, data=X.prot,
                   method="ML",control=lmeControl(optimMethod="BFGS",maxIter=100,opt="optim"))
summary(Mod3)$tTable
```

We can see that two effects come as statistically significant: 
- Size: Decline of protist richness over patch size but only significant at day 29
- Day: average decline in protist richness over experimental time

```{r nlme_prot_rich_figure, echo=FALSE, eval=TRUE}

# Plot results

X1.1 <- X.prot %>%
  filter(day==29)
ggplot(mapping=aes(x=as.factor(Size),y=prot.rich),data=X1.1) +
  geom_boxplot(col="blue",alpha=0.5) -> p1

ggplot(mapping=aes(x=day,y=prot.rich),data=X.prot) +
  geom_boxplot(col="blue",alpha=0.5)  -> p2

grid.arrange(p1,p2,ncol=2)

```

## Conclusion on aggregate metrics

We did not detect any effects of our main treatments in the Blue ecosystem on bacteria and protist densities or on protist richness. We did detect effects of patch size and changes over time. Those effects of patch size on aggegate metrics were thus independant of being connected or not and represent constraints of the dendritic spatial networks on richnes and density. Those patterns found here, especially on species richness, have already been analysed comprehensibly and published elsewhere (please see Harvey et al., Proc.B., in press)  
